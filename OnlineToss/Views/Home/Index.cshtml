@model IEnumerable<OnlineToss.Models.Products>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



<h2 class="my-5">Toss 有點有保庇列表</h2>

<div id="adForProducts" class="carousel slide" data-ride="carousel">
    <ol class="carousel-indicators">
        <li data-target="#adForProducts" data-slide-to="0" class="active"></li>

    </ol>

    @*<div class="navbar-collapse ml-3 logout text-right " style="border-radius: 10px ; ">
            <p>@Html.ActionLink("登入", "Login", "Login", null, new { @class = "nav-link btn btn-dark text-light textbold" })</p>
        </div>*@


    @*-----------------商品跑馬燈區----------------*@
    <div class="carousel-inner my-3">

        @foreach (var item in Model)
        {
            <div class="carousel-item  ">
                @*//@IsActive(c)是自訂helper*@

                <div class="center "><img src="@Url.Action("GetImage", "Products", new { id = item.ProID })" class="d-block w-auto center bg-dark" /> </div>
                <div class="carousel-caption d-none d-md-block">
                    <h5 class="text-truncate bg-dark">@item.ProName</h5>
                    @*<p class="text-truncate bg-dark">@item.Description</p>*@
                </div>
            </div>
        }
    </div>
</div>
@*<button class="carousel-control-prev" type="button" data-target="#adForProducts" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-target="#adForProducts" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </button>
    </div>*@

@*-------讀出商品迴圈--------*@
<div class="row">
    @foreach (var item in Model)
    {
        <div class="col-md-3 p-1">
            <div class="card border-light shadow h-100">
                <div class="card-body text-center">
                    <a href="@Url.Action("DisplayByTitle", new { title=Server.UrlEncode(item.ProName)})">
                        <img src="@Url.Action("GetImage","Products",new { id=item.ProID})" class="img-fluid pt-2" />
                        <input type="hidden" value="@item.ProID" class="PID" />
                        <h5 class="text-dark"><strong class="PName">@item.ProName</strong></h5>
                        <h3 class="text-danger Price" p="@item.UnitPrice">@Html.DisplayFor(modelItem => item.UnitPrice)</h3>
                    </a>
                </div>

                <div class="p-2">
                    <p><button class="btn btn-dark btn-block addCart">加入購物車 <i class="bi bi-cart-plus"></i></button></p>
                </div>
            </div>
        </div>
    }

    @*//迴圈裡面取ID要通通不一樣///寫class可以很多個//要抓的通通設class*@    @*//會讀helper@Html.DisplayFor //不會讀helper@item.UnitPrice*@
</div>

<span id="MyCart">

    <a href="@Url.Action("MyCart")">
        <i class="bi bi-cart-plus-fill"></i>
        <span class="badge  text-white " style="font-size:1.3rem"></span>
    </a>


</span>

@section css{
    <style>
        a:hover {
            text-decoration: none;
        }

        #MyCart {
            position: fixed;
            right: 60px;
            bottom: 70px;
            font-size: 3rem;
        }

            #MyCart > i {
                text-shadow: 0 0 4px #ffd800;
            }

            #MyCart > span {
                font-size: 1rem;
            }
    </style>
}

@*購物車JS寫法*@
@section scripts{
    <script>
        var cart = [];

        if (localStorage.getItem("cart")) {
            cart = JSON.parse(localStorage.getItem("cart"));
        }

        $('#MyCart .badge').text(cart.length);//購物小車新增時數字跳變

        $('.addCart').click(function () {
            let product = $(this).closest('.card');
            let newPID = product.find('.PID').val();

            let foundItem = cart.find(item => item.PID == newPID);

            if (foundItem === undefined) {
                setCart(product);
            }
            else {
                foundItem.Amount += 1;
                alert("購物車已更新");
            }


            //底下寫地太冗長了,改個寫法
            //if (cart.length > 0) {
            //    for (let i in cart) {
            //        if (cart[i]["PID"] == newPID) {
            //            //代表此商品已經在購物車中,因此將數量加1
            //            cart[i]["Amount"] += 1;
            //            alert("商品數量已更新");
            //            break;
            //        }
            //        else if (cart.length-1 == i) {
            //            setCart(product);
            //        }
            //    }
            //}
            //else {
            //    setCart(product);
            //}

            console.log(cart);

            localStorage.setItem("cart", JSON.stringify(cart));

        })
        function setCart(product) {
            let newItem = {
                PID: product.find('.PID').val(),
                PName: product.find('.PName').text(),
                Price: product.find('.Price').attr('p'),
                Amount: 1
            }

            cart.push(newItem);
            $('#MyCart .badge').text(cart.length); //購物小車新增時數字跳變
            //存在網頁空間//F5就會消失
            alert("您已加入一件商品");


        }
    </script>


}
